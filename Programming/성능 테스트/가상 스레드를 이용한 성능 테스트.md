Java 21+ ê°€ìƒ ìŠ¤ë ˆë“œë¥¼ ì´ìš©í•œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ 

JDK 24 Release ì´í›„ í”Œë«í¼ ìŠ¤ë ˆë“œ vs ê°€ìƒ ìŠ¤ë ˆë“œì˜ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œ ì˜¤ëœë§Œì— ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ ê°„ë‹¨í•˜ê²Œ APIë¥¼ êµ¬í˜„í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ìŠµë‹ˆë‹¤.

ì‹¤ì œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ëŠ” ì½”ë“œ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ê³ , gatlingì´ë¼ëŠ” gradle í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ì—¬ taskë¡œ ì‹¤í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.

ìŠ¤í”„ë§ ë¶€íŠ¸ 3.2 ì´í›„ë¶€í„°ëŠ” application.yml íŒŒì¼ì—ì„œ spring.threads.virtual.enabled ì„¤ì •ì„ ì§€ì›í•˜ê³  ìˆì–´ì„œ í”Œë«í¼ ìŠ¤ë ˆë“œì™€ ê°€ìƒ ìŠ¤ë ˆë“œë¡œ ìŠ¤ìœ„ì¹­ ë³€ê²½ì´ ìš©ì´í•´ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤.

ì•„ë˜ì™€ ê°™ì€ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì½”ë“œê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.
#### ì½”ë“œê¸°ë°˜ì˜ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ 
```kotlin
package simulations  
  
import io.gatling.javaapi.core.CoreDsl.exec  
import io.gatling.javaapi.core.CoreDsl.rampUsers  
import io.gatling.javaapi.core.CoreDsl.scenario  
import io.gatling.javaapi.core.Simulation  
import io.gatling.javaapi.http.HttpDsl.http  
import io.gatling.javaapi.http.HttpDsl.status  
import java.time.Duration  
  
class AsyncVsVirtualSimulation : Simulation() {  
  
    private val httpProtocol = http.baseUrl("http://localhost:8080")  
        .acceptHeader("application/json")  
  
    // virtual-thread ì»¨íŠ¸ë¡¤ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤  
    private val virtualScenario = scenario("Virtual Thread Controller")  
        .during(Duration.ofMinutes(2)).on (  
            exec(http("GET /vthread")  
                .get("/vthread")  
                .check(status().`is`(200))  
            )  
        )  
  
    init {  
        setUp(  
            virtualScenario.injectOpen(  
                rampUsers(500).during(Duration.ofSeconds(30))  
            )  
        ).protocols(httpProtocol)  
            .maxDuration(Duration.ofMinutes(3))  
    }  
}
```

í…ŒìŠ¤íŠ¸ëŠ” 2ë¶„ë™ì•ˆ APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ í•˜ì˜€ê³ , ì‹¤ì œ ìš´ì˜í™˜ê²½ê³¼ ìœ ì‚¬í•˜ê²Œ 30ì´ˆë™ì•ˆ ê°€ìƒ ìœ ì € 500ëª…ì´ ì ì§„ì ìœ¼ë¡œ í˜¸ì¶œí•˜ë„ë¡ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.
#### API ì½”ë“œ ì‘ì„±
```kotlin
@RestController  
class VirtualThreadController {  
  
    @GetMapping("/vthread")  
    fun executeAsyncRequest(): String {  
        println("ğŸ§µ ${Thread.currentThread().name} / vthread:isVirtual: ${Thread.currentThread().isVirtual}")  
        Thread.sleep(100)  
        return "vthread"  
    }  
}
```

gatlingRun taskë¥¼ ì‹¤í–‰í•˜ë©´ build/reports/gatling í•˜ìœ„ì— ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ì„œê°€ html íŒŒì¼ë¡œ ìƒì„±ì´ ë©ë‹ˆë‹¤.

![gatling](../../Attached%20file/gatling.png)

ë¨¼ì €, spring.threads.virtual.enabled = falseë¡œ ì„¤ì • í›„ í”Œë«í¼ ìŠ¤ë ˆë“œ ê¸°ë°˜ìœ¼ë¡œ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ìŠµë‹ˆë‹¤.
#### í”Œë«í¼ ìŠ¤ë ˆë“œ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
![platform thread test](../../Attached%20file/platform%20thread%20test.png)

#### ê°€ìƒ ìŠ¤ë ˆë“œ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
![virtual thread test](../../Attached%20file/virtual%20thread%20test.png)

ë‹¨ìˆœ APIë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í–ˆì§€ë§Œ.. ë¦¬í¬íŠ¸ë¥¼ ë³´ë©´ ê°€ìƒ ìŠ¤ë ˆë“œ ê¸°ë°˜ì˜ APIê°€ ì „ì²´ì ìœ¼ë¡œ ì„±ëŠ¥ë©´ì—ì„œ ë” íš¨ìœ¨ì ì¸ ì§€í‘œë¥¼ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤.

ì–´ë–»ê²Œ ê°€ìƒ ìŠ¤ë ˆë“œê°€ í”Œë«í¼ ìŠ¤ë ˆë“œë³´ë‹¤ ì„±ëŠ¥ì ìœ¼ë¡œ ì¢‹ì€ì§€ ê¶ê¸ˆí•˜ì—¬ gptì™€ êµ¬ê¸€ë§ì„ í†µí•´ ì¡°ì‚¬í•´ë³¸ ê²°ê³¼ ê°€ìƒ ìŠ¤ë ˆë“œì˜ ê²½ìš° JVM ë‚´ë¶€ì—ì„œ ìƒì„±ë˜ê³  ê´€ë¦¬ë˜ê¸° ë•Œë¬¸ì— ìƒì„± ë¹„ìš© ìì²´ë„ ì €ë ´í•˜ê³ , í†°ìº£ì´ ê´€ë¦¬í•˜ëŠ” í”Œë«í¼ ìŠ¤ë ˆë“œì™€ ë‹¤ë¥´ê²Œ ìˆ˜ë§Œ ê°œì˜ ë™ì‹œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

JVM ì¹œí™”ì ì¸ APIì˜ ê²½ìš°ì—ëŠ” ë¸”ë¡œí‚¹ ì‹œ ìºë¦¬ì–´ ìŠ¤ë ˆë“œë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ê²ƒë„ ì¥ì ì…ë‹ˆë‹¤. 



|          | ê°€ìƒ ìŠ¤ë ˆë“œ(Virtual Thread)      | í”Œë«í¼ ìŠ¤ë ˆë“œ(Platform Thread)           |
| -------- | --------------------------- | ---------------------------------- |
| ìƒì„±ë¹„ìš©     | ë§¤ìš° ì €ë ´í•¨(ìˆ˜ì²œê°œ ìƒì„± ê°€ëŠ¥)           | ë¬´ê²ê³  ìƒì„± ë¹„ìš© í¼                        |
| ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ | JVM ë‚´ë¶€ì—ì„œ ì²˜ë¦¬                 | OS ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì²˜ë¦¬                        |
| ë™ì‹œì„± ì²˜ë¦¬   | ìˆ˜ë§Œ ê°œ ë™ì‹œ ì²˜ë¦¬ ê°€ëŠ¥               | ìˆ˜ë°±ê°œ ìˆ˜ì¤€ì´ í•œê³„(í†°ìº£ì˜ ê²½ìš° ë””í´íŠ¸ ìŠ¤ë ˆë“œ ìˆ˜ëŠ” 200ê°œ) |
| ë¸”ë¡œí‚¹      | ë¸”ë¡œí‚¹ ì‹œ ìºë¦¬ì–´ ìŠ¤ë ˆë“œ ë°˜í™˜(ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ ì¦ê°€) | ë¸”ë¡œí‚¹ ì‹œ ìŠ¤ë ˆë“œ ì ìœ (ë¦¬ì†ŒìŠ¤ ë‚­ë¹„)               |

ì´ë ‡ê²Œë§Œ ë³´ë©´ ê°€ìƒ ìŠ¤ë ˆë“œê°€ ì—„ì²­ ì¢‹ì•„ë³´ì´ì§€ë§Œ, ìºë¦¬ì–´ ìŠ¤ë ˆë“œë¥¼ ë¬´ì¡°ê±´ unmount í•˜ì§€ëŠ” ì•Šê³  ìˆìŠµë‹ˆë‹¤.
ëŒ€í‘œì ìœ¼ë¡œ Thread.sleep()ì™€ ê°™ì´ JVMì´ ë¸”ë¡œí‚¹ì„ ê°ì§€í•  ìˆ˜ ìˆëŠ” APIì— ëŒ€í•´ì„œë§Œ ìºë¦¬ì–´ ìŠ¤ë ˆë“œì˜ unmountê°€ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì‹¤ë¬´ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” JDBC
